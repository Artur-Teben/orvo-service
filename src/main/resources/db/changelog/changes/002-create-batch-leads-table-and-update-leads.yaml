databaseChangeLog:
  - changeSet:
      id: 002-create-batch-leads-table-and-update-leads
      author: artur teben
      changes:
        # Drop batch_id from leads (since we're moving it to batch_leads)
        - dropColumn:
            tableName: leads
            columnName: batch_id

        # Create batch_leads table
        - createTable:
            tableName: batch_leads
            columns:
              - column:
                  name: id
                  type: bigint
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: batch_id
                  type: uuid
                  constraints:
                    nullable: false
              - column:
                  name: lead_id
                  type: bigint
                  constraints:
                    nullable: false
                    foreignKeyName: fk_batch_leads_lead
                    references: leads(id)
                    deleteCascade: true
              - column:
                  name: created_at
                  type: timestamp
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false

        # Add unique constraint to batch_leads (batch_id + lead_id)
        - addUniqueConstraint:
            tableName: batch_leads
            columnNames: batch_id, lead_id
            constraintName: uq_batch_id_lead_id

        # Index for efficient lookup by batch_id
        - createIndex:
            indexName: idx_batch_leads_batch_id
            tableName: batch_leads
            columns:
              - column:
                  name: batch_id

        # Index for efficient lookup by lead_id
        - createIndex:
            indexName: idx_batch_leads_lead_id
            tableName: batch_leads
            columns:
              - column:
                  name: lead_id
